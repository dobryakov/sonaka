# Implementation Plan: Личный кабинет покупателя — дашборд заказов

**Branch**: `001-customer-orders-dashboard` | **Date**: 2025-11-03 | **Spec**: [link](spec.md)
**Input**: Feature specification from `/specs/001-customer-orders-dashboard/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command.

## Summary

Реализация личного кабинета покупателя интернет-магазина Sonaka с дашбордом заказов, общей суммой покупок, списком ранее купленных товаров и детальным просмотром заказов. Используется технологический стек: Docker, Ruby on Rails (backend API), React (frontend SPA), PostgreSQL (database).

## Technical Context

**Language/Version**: Ruby 3.x (Rails), Node.js 18+ (React), PostgreSQL 15+  
**Primary Dependencies**: 
- Backend: Ruby on Rails, PostgreSQL, JWT для аутентификации
- Frontend: React, React Router, fetch/axios для API  
**Storage**: PostgreSQL для данных, Redis (опционально) для кэширования  
**Testing**: 
- Backend: RSpec, FactoryBot
- Frontend: Jest, React Testing Library
- E2E: Playwright (отдельный Docker‑сервис и отдельная CI‑джоба)  
**Target Platform**: Веб-браузеры (desktop + mobile responsive)  
**Project Type**: Web (frontend + backend)  
**Performance Goals**: 
- 95% пользователей видят дашборд < 2 с (SC-001)
- 90% пользователей открывают детали заказа < 30 с (SC-002)  
**Precision**:
- Денежные значения округляются банковским методом (half‑to‑even) до 2 знаков (FR‑012); покрыто unit‑тестами и контрактными тестами.
**Constraints**: 
- Интерфейс на русском языке
- Glass-morphism UI с мягкими светло-зелёными цветами
- REST API без серверного HTML  
**Scale/Scope**: 
- 1M заказов на клиента (ленивая загрузка)
- Мультивалютная система с историческими курсами
- Полная изоляция данных по пользователям

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Core Principles Compliance

✅ **Контейнер‑первая архитектура (Docker‑Compose)**
- Все сервисы упакованы в Docker контейнеры
- Сервисные порты > 10000 (backend: 10001, frontend: 10002, postgres: 10003)
- Конфигурация в `.env` (см. quickstart.md)

✅ **Автоматизированное тестирование как обязательство**
- Backend: RSpec + FactoryBot (spec/models/, spec/services/, spec/requests/)
- Frontend: Jest + React Testing Library (tests/components/, tests/pages/)
- E2E: Playwright для UI (отдельный Docker‑сервис и отдельная CI‑джоба)
- Отдельный набор тестовых данных в db/seeds.rb для быстрого старта

✅ **Язык интерфейса — русский**
- Все UI строки локализованы через react-i18next
- Отсутствие ключей локализации = дефект
- Error messages на русском (см. contracts/openapi.yaml)

✅ **Бэкенд: Ruby on Rails + PostgreSQL**
- REST API только (controllers/api/v1/)
- Миграции для схемы БД (db/migrations/)
- Сиды/фикстуры для тестов (db/seeds.rb, spec/factories/)

✅ **Фронтенд: React с фирменным UI**
- SPA, светло‑зелёные цвета, glass‑morphism (см. CSS в frontend/)
- Доступность и производительность соблюдены (prefers-reduced-motion)
- Предпочитаемое уменьшение движения (WCAG AA)

### Gates Evaluation

**GATE-1**: Технический стек соответствует конституции → ✅ PASS  
**GATE-2**: Архитектура изолирует ответственность сервисов → ✅ PASS  
**GATE-3**: План тестирования покрывает все уровни → ✅ PASS  
**GATE-4**: Пустые состояния и граничные случаи учтены → ✅ PASS

### Post-Phase 1 Verification

✅ **Дизайн документы созданы**: research.md, data-model.md, contracts/, quickstart.md  
✅ **API контракты определены**: openapi.yaml с 3 endpoints (User Stories 1-3)  
✅ **Модели данных спроектированы**: 5 сущностей с валидациями и индексами  
✅ **Производительность учтена**: индексы для SC-001 (<2s), SC-002 (<30s)  
✅ **Agent context обновлён**: .cursor/rules/specify-rules.mdc с технологиями  
✅ **Все NEEDS CLARIFICATION разрешены**: 0 неясностей в техническом контексте

## Project Structure

### Documentation (this feature)

```text
specs/001-customer-orders-dashboard/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
│   ├── openapi.yaml     # REST API спецификация
│   └── README.md
└── tasks.md             # Phase 2 output (not created by /speckit.plan)
```

### Source Code (repository root)

```text
# Web application structure (frontend + backend)
backend/
├── Dockerfile
├── Gemfile
├── config/
│   ├── database.yml
│   └── routes.rb
├── app/
│   ├── models/
│   │   ├── customer.rb
│   │   ├── order.rb
│   │   ├── order_item.rb
│   │   └── product.rb
│   ├── controllers/
│   │   ├── api/v1/
│   │   │   ├── orders_controller.rb
│   │   │   ├── dashboard_controller.rb
│   │   │   └── previously_purchased_controller.rb
│   │   └── application_controller.rb
│   ├── services/
│   │   ├── dashboard_totals_calculator.rb
│   │   ├── currency_converter.rb
│   │   └── order_status_filter.rb
│   └── serializers/
│       ├── order_serializer.rb
│       ├── order_item_serializer.rb
│       └── dashboard_serializer.rb
├── db/
│   ├── migrations/
│   └── seeds.rb
└── spec/
    ├── factories/
    │   ├── customers.rb
    │   ├── orders.rb
    │   ├── order_items.rb
    │   └── products.rb
    ├── models/
    ├── controllers/
    ├── services/
    └── integration/

frontend/
├── Dockerfile
├── package.json
├── src/
│   ├── components/
│   │   ├── Dashboard/
│   │   │   ├── OrdersList.tsx
│   │   │   ├── DashboardTotals.tsx
│   │   │   └── PreviouslyPurchasedList.tsx
│   │   ├── OrderDetails/
│   │   │   ├── OrderDetailsView.tsx
│   │   │   └── OrderItemCard.tsx
│   │   ├── common/
│   │   │   ├── EmptyState.tsx
│   │   │   ├── LoadingSpinner.tsx
│   │   │   └── InfiniteScrollList.tsx
│   │   └── layout/
│   │       └── AppLayout.tsx
│   ├── pages/
│   │   ├── DashboardPage.tsx
│   │   └── OrderDetailsPage.tsx
│   ├── services/
│   │   ├── api.ts
│   │   ├── ordersService.ts
│   │   └── dashboardService.ts
│   ├── types/
│   │   ├── order.ts
│   │   ├── product.ts
│   │   └── dashboard.ts
│   ├── hooks/
│   │   └── useInfiniteScroll.ts
│   └── App.tsx
├── public/
└── tests/
    ├── __mocks__/
    ├── components/
    ├── pages/
    └── e2e/

docker-compose.yml
.env
.gitignore
README.md
```

**Structure Decision**: Web application (Option 2) выбрана, так как фича требует backend API (Rails) для бизнес-логики и данных, и frontend SPA (React) для UI. Все сервисы разделены по контейнерам согласно конституции.

## Complexity Tracking

> **No violations identified**

